@inject NavigationManager NavigationManager
@inject ConfProgram.Services.ConferenceService ConferenceService

<!-- Кнопка-бургер -->
<button type="button" class="burger-button" @onclick="ToggleSidebar">
    <span class="navbar-toggler-icon"></span>
</button>

<!-- Сайдбар -->
<div class="sidebar @(isSidebarVisible ? "show" : "") p-3 text-white bg-dark">
    <h5 class="mb-3">Навигация</h5>

    <ul class="menu">
        <li>
            <a class="@GetActive("/")" @onclick="@(() => NavigateTo("/"))">Главная</a>
        </li>
        <li>
            <a class="@GetActive("/program")" @onclick="@(() => NavigateTo("/program"))">Программа</a>
        </li>

        @foreach (var part in ConferenceService.Data.Parts)
        {
            <li class="dropdown">
                <a class="@GetActive($"/room/{part.Id}")"
                   @onclick="@(() => NavigateTo($"/room/{part.Id}"))">
                    @part.Name
                </a>

                <ul class="submenu">
                    @foreach (var room in part.Rooms)
                    {
                        var url = $"/room/{part.Id}?room={room.Id}";
                        <li>
                            <a class="@GetActive(url)"
                               @onclick="@(() => NavigateTo(url))">
                                @room.Title
                            </a>
                        </li>
                    }
                </ul>
            </li>
        }
    </ul>
</div>

@code {
    private bool isSidebarVisible = false;

    [Parameter]
    public EventCallback<bool> OnToggleSidebar { get; set; }

    private async void ToggleSidebar()
    {
        isSidebarVisible = !isSidebarVisible;
        await OnToggleSidebar.InvokeAsync(isSidebarVisible);
    }

    private async void NavigateTo(string url)
    {
        NavigationManager.NavigateTo(url);
        await Task.Yield();
        await InvokeAsync(StateHasChanged);
    }

    private string GetActive(string href)
    {
        var current = NavigationManager.Uri;
        var uri = new Uri(current);
        return uri.AbsolutePath.Equals(href, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    protected override async Task OnInitializedAsync()
    {
        if (ConferenceService.Data.Parts.Count == 0)
        {
            await ConferenceService.LoadDataAsync();
        }
    }
}
